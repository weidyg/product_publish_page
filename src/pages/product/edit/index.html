<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title></title>
</head>

<body>
  <div id="root"></div>
  <script src="/assets/js/post.js"> </script>
  <script>

    function getDataInput(id, categoryId, shopId, origSpuId, type) {
      id = id || getQueryString('id');
      origSpuId = origSpuId || getQueryString('origSpuId');
      type = type || getQueryString('type');
      shopId = shopId || getQueryString('shopId');
      categoryId = categoryId || getQueryString('categoryId');
      return { ItemId: id, OrigSpuId: origSpuId, Type: type, ShopId: shopId, CategoryId: categoryId, };
    }

    // var prodEditConfig = { btn: { publish: false } };
    const baseUrl = 'http://localhost:60486/api/services/app/ProductPublish/';
    const productEditUrls = {
      loadDataWithoutUploadItem: baseUrl + "GetProductEditDataWithoutUploadItem",
      loadData: baseUrl + "GetProductEditData",
      saveData: baseUrl + "SaveProductEditData",
      getOptions: baseUrl + "GetOptions",
      getImagePageList: baseUrl + "GetImagePageList",
      uploadImages: baseUrl + "UploadImages",
    }

    function ConverData(data) {
      data = data || {};
      return {
        itemId: data.Id,
        platformId: data.PlatformId,
        shopId: data.ShopId,
        platformName: data.PlatformName,
        shopName: data.ShopName,
        categoryId: data.CategoryId,
        categoryNamePath: data.CategoryNamePath,
        formSchema: data.FormSchemaJson ? JSON.parse(data.FormSchemaJson) : undefined,
        formData: data.FormDataJson ? JSON.parse(data.FormDataJson) : undefined,
        origProdInfo: data.OrigProdJson ? JSON.parse(data.OrigProdJson) : undefined,
      }
    }

    function loadProductEditData(categoryId, shopId) {
      const input = getDataInput(undefined, categoryId, shopId, undefined, undefined);
      if (input?.ItemId > 0) {
        return post(productEditUrls.loadData, input, ConverData);
      } else if (input?.OrigSpuId > 0 && input?.ShopId > 0) {
        return post(productEditUrls.loadDataWithoutUploadItem, input, ConverData);
      } else {
        return Promise.reject({ code: 0, message: "参数错误", });
      }
    }

    function saveProductEditData(id, dataJson, publish) {
      const data = { ItemId: id, IsPublish: publish, DataJson: JSON.stringify(dataJson) };
      return post(productEditUrls.saveData, data);
    }
    function getRemoteOptions(shopId, categoryId, optionAction, forceUpdate) {
      const data = { ShopId: shopId, CategoryId: categoryId, Action: optionAction, ForceUpdate: forceUpdate };
      return post(productEditUrls.getOptions, data);
    }
    function getImagePageList(keyword, folderId, refType, sortName, sortAsc, pageNo, pageSize) {
      const data = { Keyword: keyword, FolderId: folderId, RefType: refType, SortName: sortName, SortAsc: sortAsc, Page: pageNo, PageSize: pageSize };
      return post(productEditUrls.getImagePageList, data).then(function (data) {
        data = data || {};
        const total = data.TotalCount || {};
        const items = data.Items.map(m => {
          return ConverImageInfo(m);
        })
        return { total, items }
      });
    }
    function getImageUploadConfig() {
      const action = productEditUrls.uploadImages;
      const convertRequest = (request) => {
        if (!request) { return {}; }
        const _request = {
          FolderId: request.folderId,
          ImgPix: request.pix,
        }
        return _request;
      };
      const convertResponse = (response) => {
        if (!response) { return {}; }
        const s = response.Success;
        const e = response.Error;
        const m = response.Result;
        const result = (s && m && ConverImageInfo(m)) || {};
        result.error = e && {
          code: e.Code,
          message: e.Message,
          details: e.Details,
        };
        return result;
      };
      return { action, convertRequest, convertResponse };
    }
    function ConverImageInfo(m) {
      return {
        id: m.Id,
        name: m.FileName,
        size: m.FileSize,
        pix: m.ImgPix,
        url: m.Url,
        folderId: m.FolderId,
        time: m.CreationTime,
      }
    }
  </script>
  <script type="module" src="main.tsx"></script>
</body>

</html>